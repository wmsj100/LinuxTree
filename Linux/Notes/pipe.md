---
title: 管道
date: 2020-03-13 18:40:47
modify: 
tags: [Notes]
categories: Linux
author: wmsj100
email: wmsj100@hotmail.com
---

# 管道

## 概要

- 管道是UNIX环境中历史最悠久的进程间通信方式.

## 解释

- 管道本质上就是一个文件,前面的进程以写方式打开文件,后面的进程以读方式打开.
- 前面写完后面读,于是实现了通信.
- 管道的设计也遵循UNIX的一切皆文件设计原则.
- Linux系统直接把管道实现成了一种文件系统,借助VFS给应用程序提供操作接口.
- 虽然实现形态上是文件,但是管道本身并不占用磁盘或外部存储空间.
- 在Linux的实现上,它占用的是内存空间.
- Linux上的管道就是一个操作方式为文件的内存缓冲区

## 分类

- 匿名管道: 通过管道符号'|'创建的管道,
	- 特点是只能在父子进程中使用,父进程在产生子进程前必须打开一个管道文件,然后fork产生子进程
	- 这样子进程通过拷贝父进程的进程地址空间获得同一个管道文件的描述符,以此达到通信目的
	- 除了父子进程外没有人知道这个管道文件的描述符,所以通过这个管道的信息无法传递给其他进程.
	- 保证了传输数据的安全性,也降低了管道的通用性.
- 命名管道: 通过mkfifo/mknod创建一个命名管道
	- `mkfife pipe` 这样就在当前目录创建了一个pipe名词的管道类型文件
	- 管道类型文件是p开头
	- `prw-r--r-- 1 ubuntu ubuntu 0 Mar 13 18:16 /home/ubuntu/Workspace/Linux/pipe|`
	- `echo wmsj100 > pipe`此时让一个进程写这个管道,这个写操作或被阻塞,因为管道另一侧没有人读,这是内核对管道文件定义的默认行为.
	- `cat pipe`让一个进程来读取管道,前面的写操作的阻塞状态才会解除.
- 匿名管道和命名管道在底层用同一种文件系统的操作行为,这种文件系统叫`pipefs`,可以在`/proc/filesystems`查看

## 管道缓冲区

- 管道实际上可以实现一个半双工通信机制.
- 使用同一个管道的父子进程可以分时给对方发送消息.
- 在管道中没有数据的情况下,对管道读操作会阻塞,直到管道内有数据为止.
- 当一次写操作不超过管道容量的时候,对管道的写操作也不会阻塞.直接将要写的数据写入管道缓冲区即可
- 管道实际上是内核控制的一个内存缓冲区,有容量上限.
- 把管道一次最多可以缓存的数据量大小叫做PIPESIZE.
- 内核在处理管道数据的时候,底层也要调用类似`read/write`这样的方法进行数据拷贝,这种内核操作每次可以操作的数据量也是有限的.
- 一般的操作长度是一个page,即默认4K字节.
- 但写操作大于PIPESIZE时会被阻塞,直到当前管道中的数据被读取为止,然后继续写操作

## 总结

- 所以好多操作比如给内存写一个巨量数据量进行科学运算,可能内存本身无法容纳这么多数据,但是通过管道可以在写入的同时就开始处理,这样就可以实现目标了.

## 参考

- [UNIX管道介绍](https://www.jianshu.com/p/b3c62923f808)
