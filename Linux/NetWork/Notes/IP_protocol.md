---
title: IP协议
date: 2018-03-17 11:28:20 Sat
modify: 2018-03-17 11:28:20 Sat
tag: [ip,net]
categories: Network
author: wmsj100
mail: wmsj100@hotmail.com
---

# IP协议

## 基本概念

- IP协议位于网络层，是TCP/IP协议中最为核心的协议
- IP协议提供不可靠和无连接的数据传送服务
	- 不可靠：IP协议不能保证数据报能成功到达目的地，它仅仅提供传输服务，当发生某种错误时，IP协议会丢弃该数据报。传输的可靠性由上层协议来提供
	- 无连接：IP协议对每个数据报的处理是相互独立的。可以不按照发送顺序接受
- IP数据报：包含很多信息，其中就有源IP地址和目的IP地址

## IP地址分类

- 为了便于寻址以及层次化构造网络，每个IP地址被看作分为俩部分，即网络号和主机号。
- 同一个区域的所有主机有相同的网络号（即IP地址的前半部分相同）
- 区域内的每个主机（包括路由器）都有一个主机号与其对应。
- IP地址被分为ABCDE五类，
- A类给大型网络或政府机构
- B类分配给中型网络/跨国企业等
- C类分配给小型网络（华为企业内部就是用的这个类型的网络）
- D类用于多播（不常用）
- E类用于实验（不常用）

### C类地址 

- C类地址网络号范围 192.0.0.0 ~ 223.255.255.0
- C类IP地址范围：192.0.0.0 ~ 223.255.255.255
- C类IP的私有地址范围：192.168.0.0 ～ 192.168.255.255
	- 私有地址：在互联网上不使用，被用在局域网中的地址
- C类网络号可以容纳的主机号有2^8-2=254

## 子网划分

- IP地址如果只使用ABCDE类来划分，会造成大量的浪费；比如一个有500台主机的网络无法使用C类地址，但是使用B类地址6万多个主机地址只使用500个，造成IP地址大量浪费。
- 可以在ABC类网络的基础上，进一步划分子网；
- 子网占用主机的前几位，用于表示子网号
- 这样的IP=网络号+子网号+主机号
- 子网号的位数没有硬性规定，我们使用子网掩码来确定一个IP地址中哪几位是主机号。
- 同一个C类IP地址，如果子网掩码不同，那么对应的主机号也不同
- 子网掩码中的1标识了相应的网络号，0标识了主机号。将IP地址和子网掩码进行逻辑运算，结果就可以区分网络号和子网号。

### 总结

- 经常见到的子网掩码`255.255.255.0`表示的其实就是一个标准的C类IP，只能容纳254台主机。
- 但是一般我们只使用一个IP地址，然后通过路由器在针对这一个IP进行局域网IP划分，
- 路由器局域网IP划分时候子网掩码如上的话就还可以容纳254台主机，这对于中小企业肯定是足够了。

## IP路由选择

- 如果发送方与接收方直接相连（点对点）或都在一个共享网络上（以太网），那么IP数据就可以直接送达。
- 大多数情况下发送方与接收方之间通过若干个路由器连接，那么数据报就需要经过若干个路由器的转发才能到达，这就涉及到选择合适的路径进行转发。
- IP层在内存中有一个路由表（route -n），当收到一份数据报进行转发时，都要对该表进行搜索
	- 搜索路由表，如果能找到和目的IP地址完全一致的主机，则将IP数据报发向该主机
	- 搜索路由表，如果匹配主机失败，则匹配同子网的路由器(这需要子网掩码的协助)如果找到路由器，则将该IP发向该路由器
	- 搜索路由表，如果匹配同子网的路由器失败，则匹配同网络号的路由器，如果找到该路由器，则把数据报转发到该路由器
	- 如果以上都失败了，就搜索默认路由，如果默认路由存在，则发报
	- 如果都失败了，就丢掉这个包
	- 接收到数据报的路由器再按照自己的路由表继续转发，直到数据报转发到目的主机
	- 如果在转发过错中，IP数据报的TTL(生命周期)已经被减为零，则该IP数据报就被抛弃。

## NAT技术

- NAT Network Address Translation 网络地址转换
- 有时通过`ipconfig`查看IP地址时，发现自己的IP地址是`192.168.x.x`,`172.16.X.X`；
- 那是C类网或B类网的私有地址，这就是俗称的内网IP。
- 这是因为路由器采用了NAT技术，所以内网就可以使用这类IP
- NAT技术是1994年提出的，使用场景是在专用网(私网)内部已经分配内网IP的主机想要和因特网上的主机通信时，NAT技术将其转换为全球IP地址，然后与因特网连接。通过这个技术，内外多台主机都可以使用一个IP上网。
- NAT技术实现了宽带共享，提升了内网主机安全，缓解了IP地址枯竭问题

---
- IPv6支持即插即用，自动配置，所以不需要使用DHCP
- IPv6使用十六进制，允许零压缩，一连串连续的零可以用一对冒号替代

- IP多播，需要多播路由器，
- 多播地址只能用于目的地址，不能用于源地址，是尽最大努力交付，不进行ICMP差错校验，所以PING多播地址永远不会收到响应
