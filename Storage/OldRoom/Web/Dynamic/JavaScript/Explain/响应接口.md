---
title: 响应接口
date: 2016-06-12
tags: [JavaScript]
categories: Dynamic
---

大多数浏览器都有一个单独的处理进程，它由俩个任务共享，JS任务和用户界面更新任务。每个时刻只有其中一个得以执行，也就是说当JS代码运行时，用户界面不能对输入产生反应，反之亦然。或者说，当JS运行时，用户界面就被锁定了。

JS和UI更新共享的进程通常被称作浏览器UI线程。此UI线程围绕一个简单的队列系统工作。任务被保存到队列中，直至进程空闲，一旦空闲，队列中下一个任务将被检索和执行。这些任务不是运行JS代码，就是运行UI更新。包括重绘和重排版。此进程中最令人感兴趣的是每次输入都会导致一个或多个任务被添加到队列中。

浏览器在JS运行时间上面进行了限制，这是一个有必要的限制，确保恶意代码编写者不能通过无尽的密集操作锁定浏览器或用户计算机。此类限制有俩个；
1. 调用栈尺寸限制，
2. 长时间脚本限制。或者叫做长时间脚本定时器或者失控脚本定时器。但其基本思想是浏览器检测一个脚本的执行时间，等达到某个上限之后就终止脚本。此时浏览器会向用户提示一个对话框。

对于脚本的运行时间检测有俩种方法，
1. 检测脚本的运行语句数量
2. 统计脚本的执行总时间。

一个单一的JS脚本的执行最大时间是100ms；这个数字根据 Robert Miller 在 1968 年的研究。

由于UI在JS运行时无法更新，所以超过100ms，用户就不能感受到对接口的控制。

当JS脚本执行时，UI不随用户交互而更新。此时JS任务被当作用户交互的结果被创建并放到队列中，然后当原始的JS执行完成后，队列中的任务开始执行。用户交互导致UI更新给跳过，因为优先考虑的是页面上的动态部分。因此当一个脚本运行时点击一个按钮，将看不到它被按下的样子，即使它的onclick句柄被执行了。

我自己做的一个延时测试脚本，代码就不写了，大概思路就是每隔1s数字加一，其实这个即便在火狐上超过了10s也不会触发警告，因为延时1s不是说我的脚本运行了1s，而是我的脚本可能就运行了1ms，然后等待1s之后再次运行，所以这个和火狐的浏览器脚本限制中设置的10s是不一样的，它的10s是指脚本一直持续运行，而且运行时间达到10s，这才会弹出警告框。我是不是可以缩小执行时间。
这个是错的，即便设置为延时1s也无法触发限制，
在本地服务器也是无法触发。
设置一个`length`超大的循环，因为循环是无间断执行的，结果真的在火狐触发了警告。

但是有时候肯定有JS执行会超过100ms，这时候需要做的就是让出对UI线程的控制，使UI更新可以进行。让出控制意味着停止JS的执行，给UI线程机会进行更新，然后再继续执行JS。

定时器与UI的交互有助于分解长运行脚本为较短的片段。

```javascript
function greeting(){
    alert("hello world!");
}
setTimeout(greeting,250);
```

这段代码的意思是在250ms之后向UI对象插入一个JS任务运行greeting函数，在那个点之前其它的JS和UI更新都在运行。请记住第二个参数说的是什么时候将任务添加到队列，而不是说那是代码立即执行。这个任务必须等待前面的任务都执行完成之后才会执行。
