---
title: 网络层
date: 2018-03-25 17:38:10 Sun
modify: 2018-03-25 17:38:10 Sun
tag: [net]
categories: Linux
author: wmsj100
mail: wmsj100@hotmail.com
---

# 网络层

## 基本概念
- 网络层协议提供的是尽力而为的服务，网际协议IP是TCP/IP体系中俩个最主要的协议之一。
- 与IP协议配套使用的还有三个协议：
	- 地址解析协议ARP Address Resolution Protocol 位于IP协议的最底层
	- 网际控制报文协议ICMP Internet Control Message Protocol 位于顶层
	- 网际组管理协议 IGMP Internet Group Management Protocol 位于顶层
- 中间设备： 将网路互相连接起来需要使用一些中间设备，
	- 转发器： 物理层使用的中间设备
	- 网桥/桥接器：数据链路层使用的中间设备
	- 路由器： 网络层使用的中间设备
	- 网关：在网络层以上使用的中间设备
	- 当中间设备是转发器或网桥时，仅仅是把一个网络扩大了，从网络层的角度看，这仍然是一个网络，一般不称为网络互联；
	- 网关由于比较复杂，目前使用的较少
	- 通常讨论网络互联时就是指用路由器进行网络互联和路由选择

## IP
- 整个互联网就是一个单一的，抽象的网络。
- IP地址就是给互联网上的每一台主机（或路由器）的每一个接口分配一个在全世界范围内唯一的32位的标识符。
- 一个IP地址在整个互联网范围内是唯一的
- IP地址的编址共经过了三个历史阶段：
	- 分类的IP地址： 这是最基本的编址方式
	- 子网的划分： 对基本编址方式进行改进
	- 构成超网： 这是比较新的无分类编址方法，93年提出后很快得到推广

## 分类的IP地址
- 将IP地址划分为若干个固定类，每一类地址都是俩个固定长度的字段组成，第一个字段是网络号，第二个字段是主机号
- 网络号：在整个互联网范围内必须是唯一的，
- 主机号：标志主机或路由器，在它前面的网络号所指明的网络范围内必须是唯一的。
- 当某个单位申请到一个IP地址时，实际上获得了具有同样网络号的一块地址，
- 由于近年来已经广泛使用无分类IP地址进行路由选择，A/B/C类地址区分已经成为了历史。

## IP地址特点
1. 每一个IP都由网络号和主机号组成
	- IP地址管理机构在分配IP地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配
	- 路由器仅根据目的主机所连接的网络号来转发分组，不考虑目的主机的主机号，这样可以使路由表的项目数大幅减少，从而减少了路由表占用的存储空间和查找路由表的时间
2. IP地址是标志一台主机（或路由器）和一条链路的接口
	- 当一台主机同时连接到俩个网络上时这台主机就必须同时具有俩个相应的IP地址，其网络号必须是不同的。这种主机称为多归属主机；
	- 由于一个路由器至少要连接到俩个网络，因此一个路由器至少应当有俩个不同的IP地址
3. 按照互联网观点，一个网络是指具有相同网络号的主机的集合，
	- 因此用转发器或网桥连接起来的若干个局域网仍然是一个网络，因为这些局域网都具有同样的网络号。
	- 具有不同网络号的局域网必须使用路由器进行互联
4. 在IP地址中，所有分配到网络号的网络（不管是范围很小的局域网还是范围很广的广域网）都是平等的，所谓平等是指互联网同等对待每一个IP地址
	- 在同一个网络上的主机或路由器的IP地址中的网络号必须是一样的
	- 用网桥互连的网端仍然是一个局域网，只能由一个网络号。
	- 路由器总是具有俩个或俩个以上的IP地址。即路由器的每一个接口都有一个不同的网络号IP地址。
	- 当俩个路由器互相直连时，在连线俩端的接口处可以分配也可以部分配IP地址。
		- 如果分配了IP地址，则这一段连续就构成了一种只包含一段线路的特殊网络，称为网络时因为有IP地址
		- 但为了节省IP地址，对于这样仅由一段连线构成的特殊网络现在常常部分配IP地址，把这样特殊的网络叫做无编号网络或无名网络。

## IP地址与硬件地址
- 物理地址是数据链路层和物理层使用的地址（MAC地址），是存储再适配器上的
- IP地址是网络层和以上各层使用的地址，是一种逻辑地址，是通过软件实现的
- IP地址放在IP数据报的首部
- MAC地址放在MAC帧的首部
- 路由器因为同时连接到俩个局域网上，因此它有俩个MAC地址
- 在IP层抽象的互联网只能看到IP数据报，虽然经过了路由器的转发，但是它的首部中IP源地址和IP目的地址不变，俩个路由器上的IP地址不会出现在IP数据报上
- 虽然IP数据报首部有源站的IP地址，但路由器只根据目的站的IP地址的网络号进行路由选择
- 在局域网的链路层，只能看见MAC帧，IP数据报被封装在MAC帧中，MAC帧在不同的网络上传送时，其MAC帧首部的源地址和目的地址要发生改变。
- 尽管连接在互联网上的硬件地址体系各不相同，但IP层抽象的互联网却屏蔽了下层这些很复杂的细节，只要在网络层上讨论问题，就能够使用统一的，抽象的IP地址研究主机和主机或路由器之间的通信。

## 地址解析协议ARP
- ARP协议的用途是为了从网络层使用的IP地址解析出数据链路层使用的硬件地址。
- 每一台主机都设有一个ARP高速缓存，里面有本局域网上的各主机和路由器的IP地址到硬件地址的映射表，这个表是动态更新的。
- ARP获取MAC地址过程：
	- 主机A运行ARP，ARP进程在本局域网上广播发送一个ARP请求分组，ARP请求分组的主要内容是：“我的IP地址是209.0.0.5，硬件地址是00-00-C0-15-AD-1”。我想知道IP地址位209.0.0.6的主机的硬件地址“
	- 在本局域网上的所有主机上运行的ARP进程都会收到此ARP请求分组
	- 主机B的IP地址和ARP请求分组中要查找的IP地址一致，就收下这个ARP请求分组，并向主机A发送ARP响应分组，同时在这个ARP响应分组中写入自己的硬件地址。响应分组内容是“我的IP地址是209.0.0.6，我的硬件地址是08--00--2B--00-0A”
	- 主机A收到主机B的ARP响应分组后就在其ARP告诉缓存中写入主机B的IP地址到硬件地址的映射
	- 其余所有的主机的IP地址和ARP地址的查询IP地址不匹配，所以都不理睬这个ARP请求
- ARP对保存在高速缓存中的每一个映射项目都设置有生存时间，凡超过生存时间的项目就从高速缓存中删除
- ARP只能解决同一局域网上的主机或路由器的IP地址和硬件地址的映射问题
- 从IP地址到硬件地址的解析是自动进行的，用户是不感知的。

## 为什么不使用MAC地址替换IP地址进行通信
- 由于全世界存在着各式各样的网络，他们使用不同的硬件地址。
- 要使这些异构网络能够互相通信就必须使用非常负责的硬件地址转换工作，
- 由用户或用户主机进行这样的转换工作几乎是不可能的事情。
- 但IP编址把这个复杂的问题解决了，连接到互联网的主机各自只需要拥有一个唯一的IP地址，他们之间的通信就像连接在同一个网络上一样方便
- 因为调用ARP协议的复杂过程都是由计算机软件进行的。
- 因此在虚拟的IP网络上IP地址进行通信给广大用户带来了很大的方便

## IP数据报格式
- IP数据报由首部和数据俩部分组成
- 首部的前一部分是固定的20字节长度，所有IP数据报必须具有的，后面是一些可选字段，长度可变

### IP数据报首部固定字段
- 版本： 占4位，指IP协议的版本，通信双方的版本必须一致，IPV4
- 首部长度： 占4位，默认是20字节
- 区分服务：占8位，用来获取更多服务，一般不使用这个字段
- 总长度： 首部和数据之和的长度
- 标识
- 标志
- 片偏移：
- 生存时间：指明数据报在网络中的寿命，最初单位是秒，现在单位是跳数，每经过一个路由器就把TTL的值减去1，当位0时就丢弃这个数据报；意义是数据报在互联网中至多可以经过多少个路由器
- 协议： 指出数据报携带的数据使用何种协议，以便是目的主机的IP层知道将数据部分上交给哪个协议进行处理
- 首部校验和：只检验数据报的首部，不包括数据部分
- 源地址
- 目标地址
- IP数据报首部的可变部分，因为会增加每一个路由器的开销，所以实际中很少会使用

## IP层转发分组流程
- IP数据报最终一定可以找到目的主机所在目的网络上的路由器
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付
- 可以对特定的目的主机指明一个路由，这种路由叫做特定主机路由
- 默认路由

### IP分组转发算法
1. 从数据报首部提取目的主机的IP地址D，得出目的网络N
2. 若N就是与此路由器直接相连的某个网络地址，则进行直接交付，不需要再经过其他路由器，直接把数据报交付目的主机（这里包括把目的主机地址D转换位具体的硬件地址，把数据报封装位MAC帧，再发送此帧）；否则就进行间接交付，执行3
3. 若路由器中由目的地址位D的特定主机路由，则把数据报传送给路由表中所指定的下一跳路由器；否则，执行4
4. 若路由表中由到达网络N的路由，则把数据报传送给路由表中指定的下一跳路由器；否则，执行5
5. 托路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行6；
6. 报告转发分组出错
