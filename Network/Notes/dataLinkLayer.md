---
title: 数据链路层
date: 2018-03-24 18:14:11 Sat
modify: 2018-03-24 18:14:11 Sat
tag: [net]
categories: Network
author: wmsj100
mail: wmsj100@hotmail.com
---

# 数据链路层 
## 基础概念
- 数据链路层属于计算机网络的低层
- 使用的信道主要有俩种类型：
    - 点对点信道： 使用一对一的点对点通信方式
    - 广播信道： 使用一对多的广播通信方式；过程复杂
- 局域网虽然是个网络，但局域网的问题并不归属到网络层，因为网络层研究的是多个网络互连的问题，是讨论分组怎样从一个网络通过路由器转发到另一个网络；
- 链路层的传输只是从一台主机传送到另一台主机，并不经过路由器转发。
- 数据链路层的三个基本问题是： 封装成帧、透明传输、差错检测
- 以太网MAC层的硬件地址
- 适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合
- 路由器在转发是使用的是三层协议
- 当研究数据链路层的问题时，只需要关心在协议栈中水平方向的各数据链路层。
    - 客户端链路层》路由器链路层》路由器链路层》主机链路层

## 使用点对点信道的数据链路层

### 数据链路和帧
- 链路： 从一个节点到相邻节点的物理线路（有线或无线），中间没有任何其他的交换结点。
- 数据链路： 通过通信协议控制数据在物理线路上的传输，把实现协议的硬件和软件加到链路上，就构成了数据链路。
- 现在最常用的方法是使用`网络适配器`来实现这些协议，一般的适配器都包括了数据链路层和物理层这俩层功能
- 帧： 点对点信道的数据链路层的协议数据单元
- 数据链路层把网络层交下来的数据构成帧发送到链路上，以及把接收到的帧中的数据取出并上交给网络层。

### 数据链路层通信步骤：
- 结点A把网络层交下来的IP数据报添加首部和尾部封装成帧
- 结点A把封装好的帧发送给结点B的数据链路层
- 结点B的数据链路层收到的帧无差错，则从帧中提取出IP数据报交给上面的网络层；否则丢弃这个帧

## 数据链路层协议的三个基本问题
### 封装成帧
- 所有在互联网上传输的数据都以分组（即IP数据报）为传输单位
- 网络层IP数据报就是链路层帧的数据部分
- 在一段数据的前后分别添加首部和尾部，这样就构成了一个帧
- 首部和尾部的一个重要作用就是帧定界（即确定帧的界限）
- 此外首部和尾部还包括许多必要的控制信息
- 每一种链路层协议都规定了所能传输的帧的数据部分长度上限--最大传输单元MTU(Maximum Transfer Unit)
- 帧定界可以使用特殊的帧定界符
- SOH Start Of Header 帧的首部开始
- EOT End Of Transmission 帧的结束
- 一个完整的帧必须包含`SOH`和`EOT`

### 透明传输
- 透明： 某一个实际存在的事物看起来却好像不存在一样
- 透明传输： 表示无论什么样的比特组合数据，都能够按照原样无差错地通过这个数据链路层
- 帧传输的数据中不允许出现帧的定界符，
- 如果帧数据中出现帧定界符，需要在定界符前面插入一个转义字符`ESC`，在接收端的数据链路层在把数据送往网络层之前删除这个插入的转义字符，这种方法叫做字节填充或字符填充
- 如果转义字符出现在数据中，那么就在转义字符前面再添加一个转义字符

### 差错检测
- 比特差错： 比特在传输过程中可能会出现差错，
  - 循环冗余检查（CRC）： 在数据链路层广泛使用的比特差错检测技术，就是在待传输的数据后面添加n为冗余码
  - 接收端对收到的每一帧经过CRC检查后如果余数为0表示帧没有错，可以接收；如果不为0，表示帧有差错，就丢弃
- 传输差错： 帧丢失、帧重复、帧失序；接收端接收的帧是正确的，但是整体的帧有重复或失序或丢失
  - 增加帧编号、确认和重传机制，收到正确的帧就向发送端发送确认。
  - 发送端在一定期限内没有收到对方的确认就认为出现了差错，就进行重传，直到收到对方确认为止。
- 因为现在通信质量大大改善，有链路层引起的差错概览已经大大降低，因而现在互联网采用区别对待的方法：
  1. 对于通信质量良好的传输链路，数据链路层不使用确认和重传机制，即不要求数据链路层向上层提供可靠传输服务，这个服务由上层协议来完成（TCP）
  2. 对于通信质量较差的传输链路，数据链路层就使用确认和重传机制，即向上提供可靠传输服务

## PPP 点对点协议
- PPP协议就是用户计算机和ISP（网络提供商）进行通信时所使用的数据链路层协议
- PPP协议特定： 
  - 简单：数据链路层的帧不需要纠错（只进行CRC校验）、不需要序号、也不需要流量控制，这些都在TCP中实现
  - 封装成帧：协议必须规定帧定界符，以便接收端可以准确找到帧的开始和结束
  - 透明性： 对于数据中出现帧定界符和转义符要采取有效的措施（转义）
  - 多种网络层协议： 在同一条物理链路上同时支持多种网络层协议
  - 多种类型链路： 能够在多种类型的链路上运行，如同步、异步；串行、并行；低速、高速；电的、光的；
  - 差错检查： CRC比特差错
  - 检测连接状态： 协议必须具有一种机制能够及时（不超过几分钟）自动检测链路是否处于正常工作状态；当出现故障的链路隔了一段时间后又重新恢复正常工作时要及时能检测到
  - 最大传送单元： 设置数据的最大长度值
  - 网络层地址协商： PPP协议必须能提供一种机制使通信的俩个网络层（IP层）的实体能够通过协商知道或者能配置彼此的网络层地址。因为如果仅仅在链路层建立了连接而不知道对方的网络层地址，则还不能够保证网络层可以传送分组
  - 数据压缩协商： PPP协议必须提供一种方法来协商使用数据压缩算法。

## PPP协议的组成
### PPP协议有三个组成部分
1. 一个将IP数据报封装到串行链路的方法
2. 一个用来建立、配置和测试数据链路连接的链路控制协议LCP（Link Control Protocol）。
3. 一套网络控制协议NCP（Network Control Protocol）其中的每一个协议支持不同的网络层协议，如IP网络层

## PPP协议的帧格式
- 帧的首部为四个字段，尾部为俩个字段
- 首部的第一个字段和尾部的第二个字段都是标志字段F（Flag），规定为0x7E（0X表示16进制）（01111110 连续6个1）；表示一个帧的开始或结束。标志字段就是帧的定界符。如果出现连续俩个标志字段，表示这是一个空帧，应该丢弃
- 首部中的地址字段A规定为`0xFF`，控制字段C规定为`0x03`，空白字段，没有携带PPP帧的信息
- 首部的第四个字段是2字节的协议字段，指明网络层的协议（IP）
- 尾部的第一个字段是2字节使用crc的帧检验序列FCS
- 字节填充： 使用转义
- 零比特填充： 在发送端先通过硬件扫描数据字段，只要发现5个连续的1，就在后面填入一个0，这样可以保证信息字段中不会出现6个连续1（因为帧定界符是0后面6个1）；接收端在收到一个帧时，先找到标志字段F确定帧边界，然后再用硬件对其进行比特流扫描，每发现5个连续1就删除后面的一个0，这样保证了透明传输；在所传送的数据比特流中可以传输任意组合而不会引起帧边界的错误判断

## 点对点协议PPP
- HDLC High-level Data Link Control 高级数据链路控制协议 以前线路质量差的时候经常使用，现在很少使用
- PPP Point-to-Point Protocol 点对点协议 现在广泛使用的是简单的多的点对点协议
- PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议

### PPP链接过程
- 当用户拨号接入ISP后，就建立了一条从用户个人到ISP的物理连接；
- 用户向ISP发送一系列的链路控制协议LCP分组（封装成多个PPP帧），以便建立LCP连接。
- 这些分组和响应选择了将要使用的一些PPP参数。
- 进行网络层配置，网络控制协议NCP给新接入的用户个人电脑分配一个临时的IP地址，这样用户电脑就成为了互联网上一个有IP地址的主机了。
- 当用户通信完毕，NCP释放网络连接，收回分配出去的IP地址；
- LCP释放数据链路层连接，
- 释放物理层连接
---
- PPP链路的起始和终止状态都是“链路静止“状态，这时用户主机和ISP路由器之间并不存在物理层的连接
- 当用户电脑通过调制解调器呼叫路由器时，路由器就能检测到调制解调器发出的载波信号，在双方建立了物理层连接后PPP就进入了“链路建立”状态，其目的是建立LCP连接
- LCP开始协商一些配置选项，即发送LCP的配置请求帧，这是个PPP帧，其协议字段为LCP对应的代码，而信息字段包含特定的配置请求。链路的另一端可以发送以下几种响应中的一种：
	- 配置确认帧： 所有选项都接受
	- 配置否认帧： 所有选项都理解但不能接受
	- 配置拒绝帧： 选项有的无法识别或不能接受，需要协商
- LCP配置选项包括链路上的最大帧长，所使用的鉴别协议，以及不使用PPP帧中的地址和控制协议（因为这俩个字段的值是固定的，没有任何信息，可以在PPP帧的首部忽略这俩个字节）
- LCP协议结束后双方就建立了LCP链路，接着就进入了“鉴别”状态
- 鉴别状态只允许传送LCP协议的分组，鉴别协议的分组，检测链路质量的分组。若使用口令鉴别协议PAP，则需要发起通信的一方发送身份标识符和口令。系统允许用户重试若干次。
- 若鉴别成功，则进入“网络层协议”，否则转到“链路终止”状态
- 在网络层协议状态，PPP链路俩端的NCP根据网络层的不同协议互相交换网络层特定的网络控制分组。这个步骤很重要，因为现在的路由器可以支持不同的网络层协议，PPP协议俩端的网络层可以运行不同的网络层协议，但仍然可以使用同一个PPP协议进行通信
- 如果在PPP链路上运行的是IP协议，则对PPP链路的每一端配置IP协议模块时就要使用NCP中支持IP的协议IPCP（IP Control Protocol）
- 当网络层配置完成后，链路就进入了可进行数据通信的“链路打开”状态，链路的俩个PPP端点可以彼此向对方发送分组，俩个PPP端点还可以发送回送请求LCP分组和回送回答LCP分组以检查链路的状态
- 数据传输结束后可以由链路的一端发送“终止请求”LCP分组请求终止链路连接，在收到对方发来的终止确认LCP分组后，转到链路终止状态。
- 当调制解调器的载波停止后会回到“链路静止”状态
- 设备间无链路》物理链路》LCP链路》已鉴别的LCP链路》以鉴别的链路和NCP链路
- 从设备之间无链路开始，先建立物理链路，再建立链路控制协议LCP链路，经过鉴别后再建立网络控制链路，然后才能交换数据，由此可见PPP协议不是纯粹的数据链路协议，还包含了物理层和网络层的内容。

## 使用广播信道的数据链路层
- 广播信道可以进行一对多的通信
- 当一台计算机发送数据时，总线上的所有计算机都可以检测到这个数据。
- 局域网优点：
	- 具有广播功能，从一个站点可以访问全网，局域网上的主机可以共享连接在局域网上的各种硬件和软件资源
	- 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变
	- 提高了系统的可靠性，可用性，生存性
- 以太网已经成为了局域网的同名词，以太网在局域网占据绝对优势
- 以太网同时包含了物理层和数据链路层
- 局域网的数据链路层拆分成俩个子层：
	- LLC Logical Link Control 逻辑链路控制子层 由于商业竞争 已经被淘汰
	- MAC Medium Access Control 媒体接入控制子层 
- 适配器： 计算机和局域网的连接都是通过适配器（网卡）进行的。
- 计算机的硬件地址存储在适配器的ROM中，计算机的软件地址IP存储在计算机的存储器中
- 为了实现局域网内的一对一通信，使每台计算机的适配器拥有一个独一无二的地址，在发送数据帧时，在帧的首部写明接收站的地址；仅当数据帧中的目的地址和适配器ROM中存放的硬件地址一致时，该适配器才接收这个数据帧，否则就丢弃。
- 为了通信的简便，以太网采取了俩种措施：
	- 采用无连接的工作方式：即不必先建立连接就可以发送数据，适配器对发送的数据帧不进行编号，尽最大努力交付，不可靠交付，帧校验由上层TCP执行
	- 以太网发送的数据都采用曼彻斯特编码
- 当以太网的利用率达到30%就已经处于重载的情况，很多网络容量被网上的碰撞消耗掉了。

## MAC地址
- MAC地址指局域网中每一台计算机中固化在适配器的ROM中的地址，
- 假如一台计算机的适配器坏了换了一个新的适配器，那么这台计算机的局域网“地址”也就改变了。
- 假若把位于南京的某局域网上的一台笔记本携带到北京，并且连接到北京的某局域网上，虽然电脑的地理位置变化了，但是电脑的适配器没有改变，所以电脑的MAC地址仍然没有改变
- 因为现在电脑已经内置了适配器，所以适配器的地址也就是电脑的地址
- 2字节的16为地址可以表示6万多个地址
- 6字节的48位地址可以使全世界的所有局域网适配器都具有不同的地址，因此现在局域网适配器实际采用的是6字节的MAC地址
- 生产适配器时，这种6字节的MAC地址已经被固定在适配器的ROM中，因此MAC地址也叫硬件地址或物理地址。实际上就是适配器地址
- MAC地址可以有70万亿个，预估到2020年MAC地址将耗尽
- 当路由器通过适配器连接到局域网时，适配器上的硬件地址就用来标识路由器的某个接口。路由器如果同时连接到俩个网络上，那么它就需要俩个适配器和俩个硬件地址。
- 适配器从网络上每收到一个MAC帧就先用硬件检查MAC帧中的目的地址，如果时发往本站的帧则收下，否则就丢弃。

## MAC帧格式
- MAC帧标准现在使用最广泛的是DIX V2标准
- 前俩个字段分别为6字节的目的地址和源地址字段
- 第三个字段是类型字段，
- 第四个字段是数据字段
- 最后一个字段是帧检测序列FCS（使用CRC检验）
- MAC子层向下传到物理层时还要在MAC帧前面插入8字节，有俩个字段构成，
	- 第一个字段是7个字节的前同步码，它的作用是使接收端的适配器在收到MAC帧时能够迅速调整其时钟频率，使它和发送端的时钟同步，
	- 第二个字段是帧开始定界符
- 以太网不需要帧结束定界符，也不需要使用字节插入来保证透明传输

## 以太网交换机
- 以太网交换机实际上就是一个多接口的网桥，每一个接口都直接与某台单主机或另一台集线器相连，且工作是全双工方式。
- 以太网交换机有自学习功能，自己维护一个MAC地址的接口表

## 虚拟局域网VLAN
- 利用以太网交换机可以很方便实现虚拟局域网VLAN，
- 虚拟局域网VLAN是由一些局域网网端构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的计算机属于哪一个VLAN。
- 虚拟局域网其实只是局域网给用户提供的一种服务，而不是一种新型局域网。
- 利用以太网交换机可以很方便的将不同局域网的计算机划分到同一个虚拟局域网内
- 在虚拟局域网上的每一个站都可以收到同一个虚拟局域网上的其他成员所发出的广播。
- 虚拟局域网对以太网帧格式进行了扩展，在第二个字段源地址后面插入了一个4字节的标识符（称为VLAN标记），用来指明发送该帧的计算机属于哪一个虚拟局域网。
